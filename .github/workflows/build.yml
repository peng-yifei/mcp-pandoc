name: Build Windows EXE

on:
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      # 这一步会将你仓库里的所有文件（包括你上传的 pandoc.exe）拉取到构建服务器

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install .
        pip install pyinstaller

    # --- 删除掉了 "Download Pandoc" 步骤 ---

    - name: Create entry.py
      # 自动生成入口文件（保持不变）
      run: |
        echo "import sys, os, mcp_pandoc" > entry.py
        echo "from mcp_pandoc import main" >> entry.py
        echo "if getattr(sys, 'frozen', False):" >> entry.py
        echo "    os.environ['PYPANDOC_PANDOC'] = os.path.join(sys._MEIPASS, 'pandoc.exe')" >> entry.py
        echo "if __name__ == '__main__':" >> entry.py
        echo "    sys.exit(main())" >> entry.py

    - name: Build with PyInstaller
      # 这一步会直接寻找当前目录下的 pandoc.exe
      run: |
        # 增加一个简单的检查，防止你忘记上传文件导致报错
        if (-not (Test-Path "pandoc.exe")) {
            Write-Error "错误: 没找到 pandoc.exe！请确保你已经把 pandoc.exe 上传到了仓库的根目录。"
            exit 1
        }
        # 开始打包
        pyinstaller --onefile --name mcp-pandoc --add-binary "pandoc.exe;." entry.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mcp-pandoc-exe
        path: dist/mcp-pandoc.exe
