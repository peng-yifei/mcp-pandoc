name: Build Windows EXE

on:
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install .
        pip install pyinstaller
        
    - name: Download Pandoc (Windows)
      run: |
        # 下载
        Invoke-WebRequest -Uri "https://github.com/jgm/pandoc/releases/download/3.6/pandoc-3.6-windows-x86_64.zip" -OutFile "pandoc.zip"
        # 解压到当前目录
        Expand-Archive pandoc.zip -DestinationPath .
        
        # 关键修改：不猜文件夹名，而是递归查找 pandoc.exe 到底在哪里
        $pandocExe = Get-ChildItem -Path . -Filter pandoc.exe -Recurse | Select-Object -First 1
        
        if ($pandocExe) {
            Write-Host "Found pandoc at: $($pandocExe.FullName)"
            # 如果它不在根目录下，就把它移出来
            if ($pandocExe.Directory.FullName -ne (Get-Location).Path) {
                Move-Item $pandocExe.FullName . -Force
            }
        } else {
            Write-Error "Error: 解压后没找到 pandoc.exe！"
            exit 1
        }

    - name: Create entry.py
      # 自动生成包含路径处理的入口文件
      run: |
        echo "import sys, os, mcp_pandoc" > entry.py
        echo "from mcp_pandoc import main" >> entry.py
        echo "if getattr(sys, 'frozen', False):" >> entry.py
        echo "    os.environ['PYPANDOC_PANDOC'] = os.path.join(sys._MEIPASS, 'pandoc.exe')" >> entry.py
        echo "if __name__ == '__main__':" >> entry.py
        echo "    sys.exit(main())" >> entry.py

    - name: Build with PyInstaller
      # 关键步骤：把 pandoc.exe 打包进去
      run: |
        pyinstaller --onefile --name mcp-pandoc --add-binary "pandoc.exe;." entry.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mcp-pandoc-exe
        path: dist/mcp-pandoc.exe
