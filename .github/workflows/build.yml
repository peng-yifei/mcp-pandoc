name: Build Windows EXE

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install .
        pip install pyinstaller

    - name: Download Pandoc (Windows)
      shell: powershell
      run: |
        # 1. 下载 Pandoc 官方包
        Invoke-WebRequest -Uri "https://github.com/jgm/pandoc/releases/download/3.6/pandoc-3.6-windows-x86_64.zip" -OutFile "pandoc.zip"
        # 2. 解压
        Expand-Archive pandoc.zip -DestinationPath .
        # 3. 智能查找 pandoc.exe 并移动到根目录
        $pandocExe = Get-ChildItem -Path . -Filter pandoc.exe -Recurse | Select-Object -First 1
        if ($pandocExe) {
            Write-Host "Found pandoc at: $($pandocExe.FullName)"
            Move-Item $pandocExe.FullName . -Force
        } else {
            Write-Error "Failed to find pandoc.exe in the zip archive!"
            exit 1
        }

    - name: Create optimized entry.py
      shell: python
      run: |
        code = r"""
        import sys, os
        # --- 核心修复开始 ---
        if sys.stdout:
            sys.stdout.reconfigure(encoding='utf-8', line_buffering=True, write_through=True)
        if sys.stdin:
            sys.stdin.reconfigure(encoding='utf-8')
        # --- 核心修复结束 ---

        if getattr(sys, 'frozen', False):
            base_path = sys._MEIPASS
            pandoc_path = os.path.join(base_path, 'pandoc.exe')
            os.environ['PYPANDOC_PANDOC'] = pandoc_path
            os.environ['PANDOC_PATH'] = pandoc_path

        from mcp_pandoc import main

        if __name__ == "__main__":
            main()
        """
        with open("entry.py", "w", encoding="utf-8") as f:
            f.write(code)

    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --name mcp-pandoc --add-binary "pandoc.exe;." entry.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mcp-pandoc-exe
        path: dist/mcp-pandoc.exe
